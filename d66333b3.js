import{B as i,d as t}from"./a85561c2.js";class s{constructor(i){this._map=new Map,this._roundAverageSize=!1,this.totalSize=0,!0===(null==i?void 0:i.roundAverageSize)&&(this._roundAverageSize=!0)}set(i,t){const s=this._map.get(i)||0;this._map.set(i,t),this.totalSize+=t-s}get averageSize(){if(this._map.size>0){const i=this.totalSize/this._map.size;return this._roundAverageSize?Math.round(i):i}return 0}getSize(i){return this._map.get(i)}clear(){this._map.clear(),this.totalSize=0}}const e=i=>Object.assign({type:c},i);function h(i){return"horizontal"===i?"marginLeft":"marginTop"}function a(i){return"horizontal"===i?"marginRight":"marginBottom"}function r(i,t){const s=[i,t].sort();return s[1]<=0?Math.min(...s):s[0]>=0?Math.max(...s):s[0]+s[1]}class _{constructor(){this._childSizeCache=new s,this._marginSizeCache=new s,this._metricsCache=new Map}update(i,s){var e,_;const c=new Set;Object.keys(i).forEach((e=>{const h=Number(e);this._metricsCache.set(h,i[h]),this._childSizeCache.set(h,i[h][t(s)]),c.add(h),c.add(h+1)}));for(const i of c){const t=(null===(e=this._metricsCache.get(i))||void 0===e?void 0:e[h(s)])||0,c=(null===(_=this._metricsCache.get(i-1))||void 0===_?void 0:_[a(s)])||0;this._marginSizeCache.set(i,r(t,c))}}get averageChildSize(){return this._childSizeCache.averageSize}get totalChildSize(){return this._childSizeCache.totalSize}get averageMarginSize(){return this._marginSizeCache.averageSize}get totalMarginSize(){return this._marginSizeCache.totalSize}getLeadingMarginValue(i,t){var s;return(null===(s=this._metricsCache.get(i))||void 0===s?void 0:s[h(t)])||0}getChildSize(i){return this._childSizeCache.getSize(i)}getMarginSize(i){return this._marginSizeCache.getSize(i)}clear(){this._childSizeCache.clear(),this._marginSizeCache.clear(),this._metricsCache.clear()}}class c extends i{constructor(){super(...arguments),this._itemSize={width:100,height:100},this._physicalItems=new Map,this._newPhysicalItems=new Map,this._metricsCache=new _,this._anchorIdx=null,this._anchorPos=null,this._stable=!0,this._measureChildren=!0,this._estimate=!0}get measureChildren(){return this._measureChildren}updateItemSizes(i){this._metricsCache.update(i,this.direction),this._scheduleReflow()}_getPhysicalItem(i){var t;return null!==(t=this._newPhysicalItems.get(i))&&void 0!==t?t:this._physicalItems.get(i)}_getSize(i){return this._getPhysicalItem(i)&&this._metricsCache.getChildSize(i)}_getAverageSize(){return this._metricsCache.averageChildSize||this._itemSize[this._sizeDim]}_estimatePosition(i){const t=this._metricsCache;if(-1===this._first||-1===this._last)return t.averageMarginSize+i*(t.averageMarginSize+this._getAverageSize());if(i<this._first){const s=this._first-i;return this._getPhysicalItem(this._first).pos-(t.getMarginSize(this._first-1)||t.averageMarginSize)-(s*t.averageChildSize+(s-1)*t.averageMarginSize)}{const s=i-this._last;return this._getPhysicalItem(this._last).pos+(t.getChildSize(this._last)||t.averageChildSize)+(t.getMarginSize(this._last)||t.averageMarginSize)+s*(t.averageChildSize+t.averageMarginSize)}}_getPosition(i){var t;const s=this._getPhysicalItem(i),{averageMarginSize:e}=this._metricsCache;return 0===i?null!==(t=this._metricsCache.getMarginSize(0))&&void 0!==t?t:e:s?s.pos:this._estimatePosition(i)}_calculateAnchor(i,t){return i<=0?0:t>this._scrollSize-this._viewDim1?this.items.length-1:Math.max(0,Math.min(this.items.length-1,Math.floor((i+t)/2/this._delta)))}_getAnchor(i,t){if(0===this._physicalItems.size)return this._calculateAnchor(i,t);if(this._first<0)return this._calculateAnchor(i,t);if(this._last<0)return this._calculateAnchor(i,t);const s=this._getPhysicalItem(this._first),e=this._getPhysicalItem(this._last),h=s.pos;if(e.pos+this._metricsCache.getChildSize(this._last)<i)return this._calculateAnchor(i,t);if(h>t)return this._calculateAnchor(i,t);let a=this._firstVisible-1,r=-1/0;for(;r<i;){r=this._getPhysicalItem(++a).pos+this._metricsCache.getChildSize(a)}return a}_getActiveItems(){0===this._viewDim1||0===this.items.length?this._clearItems():this._getItems()}_clearItems(){this._first=-1,this._last=-1,this._physicalMin=0,this._physicalMax=0;const i=this._newPhysicalItems;this._newPhysicalItems=this._physicalItems,this._newPhysicalItems.clear(),this._physicalItems=i,this._stable=!0}_getItems(){var i,t;const s=this._newPhysicalItems;let e,h;if(this._stable=!0,null!==this.pin){const{index:i}=this.pin;this._anchorIdx=i,this._anchorPos=this._getPosition(i)}if(e=this._scrollPosition-this._overhang,h=this._scrollPosition+this._viewDim1+this._overhang,h<0||e>this._scrollSize)return void this._clearItems();null!==this._anchorIdx&&null!==this._anchorPos||(this._anchorIdx=this._getAnchor(e,h),this._anchorPos=this._getPosition(this._anchorIdx));let a=this._getSize(this._anchorIdx);void 0===a&&(this._stable=!1,a=this._getAverageSize());const r=null!==(i=this._metricsCache.getMarginSize(this._anchorIdx))&&void 0!==i?i:this._metricsCache.averageMarginSize,_=null!==(t=this._metricsCache.getMarginSize(this._anchorIdx+1))&&void 0!==t?t:this._metricsCache.averageMarginSize;0===this._anchorIdx&&(this._anchorPos=r),this._anchorIdx===this.items.length-1&&(this._anchorPos=this._scrollSize-_-a);let c=0;for(this._anchorPos+a+_<e&&(c=e-(this._anchorPos+a+_)),this._anchorPos-r>h&&(c=h-(this._anchorPos-r)),c&&(this._scrollPosition-=c,e-=c,h-=c,this._scrollError+=c),s.set(this._anchorIdx,{pos:this._anchorPos,size:a}),this._first=this._last=this._anchorIdx,this._physicalMin=this._anchorPos-r,this._physicalMax=this._anchorPos+a+_;this._physicalMin>e&&this._first>0;){let i=this._getSize(--this._first);void 0===i&&(this._stable=!1,i=this._getAverageSize());let t=this._metricsCache.getMarginSize(this._first);void 0===t&&(this._stable=!1,t=this._metricsCache.averageMarginSize),this._physicalMin-=i;const e=this._physicalMin;if(s.set(this._first,{pos:e,size:i}),this._physicalMin-=t,!1===this._stable&&!1===this._estimate)break}for(;this._physicalMax<h&&this._last<this.items.length-1;){let i=this._getSize(++this._last);void 0===i&&(this._stable=!1,i=this._getAverageSize());let t=this._metricsCache.getMarginSize(this._last);void 0===t&&(this._stable=!1,t=this._metricsCache.averageMarginSize);const e=this._physicalMax;if(s.set(this._last,{pos:e,size:i}),this._physicalMax+=i+t,!this._stable&&!this._estimate)break}const l=this._calculateError();l&&(this._physicalMin-=l,this._physicalMax-=l,this._anchorPos-=l,this._scrollPosition-=l,s.forEach((i=>i.pos-=l)),this._scrollError+=l),this._stable&&(this._newPhysicalItems=this._physicalItems,this._newPhysicalItems.clear(),this._physicalItems=s)}_calculateError(){return 0===this._first?this._physicalMin:this._physicalMin<=0?this._physicalMin-this._first*this._delta:this._last===this.items.length-1?this._physicalMax-this._scrollSize:this._physicalMax>=this._scrollSize?this._physicalMax-this._scrollSize+(this.items.length-1-this._last)*this._delta:0}_reflow(){const{_first:i,_last:t,_scrollSize:s,_firstVisible:e,_lastVisible:h}=this;this._updateScrollSize(),this._setPositionFromPin(),this._getActiveItems(),this._updateVisibleIndices(),this._scrollSize!==s&&this._emitScrollSize(),this._first===i&&this._last===t&&this._firstVisible===e&&this._lastVisible===h||this._emitRange(),-1===this._first&&-1===this._last||this._emitChildPositions(),0!==this._scrollError&&this._emitScrollError(),(-1===this._first&&-1==this._last||this._first===i&&this._last===t)&&this._resetReflowState()}_resetReflowState(){this._anchorIdx=null,this._anchorPos=null,this._stable=!0}_updateScrollSize(){const{averageMarginSize:i}=this._metricsCache;this._scrollSize=Math.max(1,this.items.length*(i+this._getAverageSize())+i)}get _delta(){const{averageMarginSize:i}=this._metricsCache;return this._getAverageSize()+i}_getItemPosition(i){var t,s;return{[this._positionDim]:this._getPosition(i),[this._secondaryPositionDim]:0,[(s=this.direction,"horizontal"===s?"xOffset":"yOffset")]:-(null!==(t=this._metricsCache.getLeadingMarginValue(i,this.direction))&&void 0!==t?t:this._metricsCache.averageMarginSize)}}_getItemSize(i){return{[this._sizeDim]:this._getSize(i)||this._getAverageSize(),[this._secondarySizeDim]:this._itemSize[this._secondarySizeDim]}}_viewDim2Changed(){this._metricsCache.clear(),this._scheduleReflow()}}export{c as FlowLayout,e as flow};
//# sourceMappingURL=d66333b3.js.map
